<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Domótica - Garaje</title>
  <style>
    body{font-family:system-ui,Arial;padding:18px;background:#f5f7fb;color:#111}
    .card{background:#fff;border-radius:8px;padding:14px;box-shadow:0 1px 6px rgba(0,0,0,.07);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    button{cursor:pointer;border:0;padding:8px 12px;border-radius:6px;font-weight:600}
    .on{background:#16a34a;color:#fff}.off{background:#ef4444;color:#fff}.action{background:#2563eb;color:#fff}
    .small{font-size:.9rem;color:#555}
    .sensor-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .status-ok{color:#16a34a;font-weight:700}
    .status-bad{color:#ef4444;font-weight:700}
    .muted{color:#666;font-size:.9rem}
  </style>
</head>
<body>
  <h1>Domótica - Garaje</h1>
  <p class="small">Control automático de luz y calefacción. Pulsadores para luz y coche; botón para calefacción.</p>

  <div class="grid">
    <section class="card">
      <h2>Controles</h2>

      <div style="margin-bottom:10px">
        <div style="font-weight:700">Calefacción (LED2)</div>
        <div class="small">Automática por temperatura. Pulsar para activar/desactivar manualmente (persistente).</div>
        <div style="margin-top:8px" id="heatControl"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Luz garaje (LED1)</div>
        <div class="small">Pulsador: enciende la luz según condiciones (10s claro / 20s oscuro sin coche).</div>
        <div style="margin-top:8px" id="lightControl"></div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Coche aparcado</div>
        <div class="small">Forzar estado de detección de coche</div>
        <div style="margin-top:8px" id="carControl"></div>
      </div>
    </section>

    <section class="card">
      <h2>Estado</h2>
      <div class="sensor-row"><div>Temperatura (visible si luz o calefacción ON)</div><div><strong id="temp">—</strong> °C</div></div>
      <div class="sensor-row"><div>Luz ambiente</div><div><strong id="light">—</strong></div></div>
      <div class="sensor-row"><div>Botón físico</div><div><strong id="btn">—</strong></div></div>
      <div class="sensor-row"><div>Coche aparcado</div><div><strong id="car">—</strong></div></div>
      <div class="sensor-row"><div>Overrides calefacción</div><div class="muted" id="overrideHeat">—</div></div>
      <div class="sensor-row"><div>Timer luz</div><div class="muted" id="lightTimer">—</div></div>
      <button id="measureBtn" class="action">Medir ahora</button>
    </section>

    <section class="card">
      <h2>Registros</h2>
      <div id="log">Sin eventos</div>
      <div style="margin-top:8px"><button id="clearLog" class="action">Borrar</button></div>
    </section>
  </div>

  <script>
    const API = {
      status: '/api/status',
      toggle: '/api/toggle',
      measure: '/api/measure',
      light_pulse: '/api/light_pulse',
      car: '/api/car'
    };

    const heatControl = document.getElementById('heatControl');
    const lightControl = document.getElementById('lightControl');
    const carControl = document.getElementById('carControl');
    const tempEl = document.getElementById('temp');
    const lightEl = document.getElementById('light');
    const btnEl = document.getElementById('btn');
    const carEl = document.getElementById('car');
    const overrideHeatEl = document.getElementById('overrideHeat');
    const lightTimerEl = document.getElementById('lightTimer');
    const logEl = document.getElementById('log');
    const measureBtn = document.getElementById('measureBtn');
    const clearLogBtn = document.getElementById('clearLog');

    function addLog(text){
      const ts = new Date().toLocaleTimeString();
      if(logEl.textContent==='Sin eventos') logEl.textContent='';
      logEl.textContent = `${ts}  ${text}\n` + logEl.textContent;
    }

    function renderHeatControl(state, manualOverride){
      heatControl.innerHTML = '';
      const label = document.createElement('div');
      label.innerHTML = `<div style="font-weight:600">Estado: ${state?'<span class="status-ok">ON</span>':'<span class="status-bad">OFF</span>'}</div>`;
      const btn = document.createElement('button');
      btn.textContent = state? 'Apagar calefacción' : 'Encender calefacción';
      btn.className = state? 'off' : 'on';
      btn.onclick = async ()=> {
        btn.disabled = true;
        try{
          const val = state? 0 : 1;
          const res = await fetch(API.toggle, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:'led2', value: val})});
          if(!res.ok) throw new Error(res.status);
          addLog(`Calefacción -> ${val? 'ON' : 'OFF'} (manual)`);
          await fetchStatus();
        }catch(e){ addLog('Error toggle calefacción: '+e.message); }
        finally{ btn.disabled = false; }
      };
      heatControl.appendChild(label);
      heatControl.appendChild(btn);
      overrideHeatEl.textContent = manualOverride ? 'Manual activo' : 'Automático';
    }

    function renderLightControl(){
      lightControl.innerHTML = '';
      const btn = document.createElement('button');
      btn.textContent = 'Pulsador luz';
      btn.className = 'action';
      btn.onclick = async ()=> {
        btn.disabled = true;
        try{
          const res = await fetch(API.light_pulse, {method:'POST'});
          if(!res.ok) throw new Error(res.status);
          const j = await res.json();
          addLog(`Pulsador luz activado (${j.duration || 0}s)`);
          await fetchStatus();
        }catch(e){ addLog('Error pulsador luz: '+e.message); }
        finally{ btn.disabled = false; }
      };
      lightControl.appendChild(btn);
    }

    function renderCarControl(state){
      carControl.innerHTML = '';
      const label = document.createElement('div');
      label.innerHTML = `<div style="font-weight:600">Estado: ${state?'<span class="status-ok">Sí</span>':'<span class="status-bad">No</span>'}</div>`;
      const btn = document.createElement('button');
      btn.textContent = state? 'Quitar coche' : 'Poner coche';
      btn.className = state? 'off' : 'on';
      btn.onclick = async ()=> {
        try{
          const val = state? 0 : 1;
          const res = await fetch(API.car, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({car: val})});
          if(!res.ok) throw new Error(res.status);
          addLog(`Coche -> ${val? 'Sí' : 'No'} (manual)`);
          await fetchStatus();
        }catch(e){ addLog('Error toggle coche: '+e.message); }
      };
      carControl.appendChild(label);
      carControl.appendChild(btn);
    }

    async function fetchStatus(){
      try{
        const res = await fetch(API.status);
        if(!res.ok) throw new Error(res.status);
        const j = await res.json();
        const outs = j.outputs || {};
        renderHeatControl(outs.led2==1, j.manual_override_heating);
        renderLightControl();
        renderCarControl(j.sensors.car_parked);

        tempEl.textContent = j.sensors.temp_c!==null? j.sensors.temp_c : '—';
        lightEl.textContent = j.sensors.light!==null? (j.sensors.light? 'Oscuro' : 'Claro') : '—';
        btnEl.textContent = j.sensors.button_pressed? 'Pulsado' : 'No';
        carEl.textContent = j.sensors.car_parked? 'Sí' : 'No';

        if(j.light_timer_until && j.light_timer_until > Date.now()/1000){
          const rem = Math.round(j.light_timer_until - Date.now()/1000);
          lightTimerEl.textContent = `${rem}s restantes`;
        } else {
          lightTimerEl.textContent = '—';
        }
      }catch(e){ addLog('Error obtener estado: '+e.message); }
    }

    async function measureNow(){
      measureBtn.disabled=true;
      try{
        const res = await fetch(API.measure, {method:'POST'});
        if(!res.ok) throw new Error(res.status);
        const j = await res.json();
        tempEl.textContent = j.temp_c!==null? j.temp_c : '—';
        lightEl.textContent = j.light!==null? (j.light? 'Oscuro' : 'Claro') : '—';
        carEl.textContent = j.car_parked? 'Sí' : 'No';
        addLog(`Medición: ${j.temp_c!==null? j.temp_c + ' °C' : '—'}, coche=${j.car_parked}`);
      }catch(e){ addLog('Error medir: '+e.message); }
      finally{ measureBtn.disabled=false; }
    }

    (function init(){
      fetchStatus();
      setInterval(fetchStatus, 1000);
      measureBtn.addEventListener('click', measureNow);
      clearLogBtn.addEventListener('click', ()=>{ logEl.textContent = 'Sin eventos'; });
      addLog('Interfaz cargada');
    })();
  </script>
</body>
</html>